<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.6.1/firebase.js"></script>
<script src="//cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
  let quill;
  $(function () {
      // Start polling for updates
      poll();
      console.log('client!');
      quill = new Quill('#editor', {
          modules: {
              toolbar: '#editor-toolbar',
          },
          placeholder: 'Write some notes...',
          theme: 'snow',
      });
  });

function setAlive() {
      var isSidebar = document.getElementById('isSidebar').innerHTML == 'true';
      if (!isSidebar) {
          google.script.run.setAlive();
      }
}

function checkAlive() {
      var isSidebar = document.getElementById('isSidebar').innerHTML == 'true';
      if (isSidebar) {
          google.script.run
              .withSuccessHandler(function (result) {
                  //document.getElementById("lastPoll").innerHTML = result;
                  //   if (result == 'false') {
                  //       document.getElementById('shouldPoll').innerHTML = 'false';
                  //   } else {
                  //       document.getElementById('shouldPoll').innerHTML = 'true';
                  //   }
              })
              .withFailureHandler(function (msg, element) {
                  //google.script.run.showAlert("Couldn't open sidebar editor",msg);
              })
              .getAlive();
      }
}

  function handleFormSubmit() {
      //   displayMessage('Saving...');
      const currentNoteContent = quill.getContents();
      const key = document.getElementById('key').innerHTML;
      const sheetname = document.getElementById('sheetName').innerHTML;
      const range = document.getElementById('rangeA1').innerHTML;
      const dbsheet = document.getElementById('dbSheet').innerHTML;
      if (currentNoteContent.length < 50000) {
          google.script.run
              //   .withSuccessHandler(displaySavedMessage)
              .getTextInput(key, sheetname, range, currentNoteContent, dbsheet);
      } else {
          //   displayMessage("Can't save. Cell note is too long!");
      }
}

  function needsSaving(currentContent) {
      const formerContent = document.getElementById('oldnote').innerHTML;

      if (currentContent && currentContent !== formerContent) {
          handleFormSubmit();
      }
  }

  function updateCellRange() {
      const dbsheet = document.getElementById('dbSheet').innerHTML;
      const currentNoteContent = quill.getContents();
      document.getElementById('current-note').innerHTML = JSON.stringify(
          currentNoteContent
      );
      //   console.log({currentNoteContent});
      needsSaving(currentNoteContent);
      if (currentNoteContent) {
          try {
              google.script.run
                  .withSuccessHandler(function (data, element) {
                      //   console.log({data});
                      if (data) {
                          const splitter = data.split('!@!@');
                          const [
                              key,
                              content,
                              sheetName,
                              rangeA1formatted,
                              error,
                          ] = splitter;
                          //   const oldError = document.getElementById('error').innerHTML;
  
                          //   displayError(error == 'true', oldError != error);
                          //   document.getElementById('error').innerHTML = error;
                          if (
                              document.getElementById('rangeA1').innerHTML !==
                              rangeA1formatted
                          ) {
                              console.log('new range');
                              // here we will need to save prior to storing new values
                              document.getElementById('key').innerHTML = key;
                              document.getElementById(
                                  'sheetName'
                              ).innerHTML = sheetName;
                              document.getElementById(
                                  'rangeA1'
                              ).innerHTML = rangeA1formatted;
  
                              console.log(
                                  {content, quill},
                                  quill.clipboard.convert(content)
                              );
                              quill.setContents(quill.clipboard.convert(content));
                              //CKEDITOR.instances.editor1.setData(content);
                              document.getElementById(
                                  'oldnote'
                              ).innerHTML = content;
                              document.getElementById(
                                  'current-note'
                              ).innerHTML = content;
                              //   displayMessage('');
                          }
                      }
                  })
                  .withFailureHandler(function (msg, element) {
                      // code to execute if data was not gotten ok
                  })
                  .getNoteForActiveRange(dbsheet);
          } catch (err) {
              console.error(err);
          }
      }
      poll();
  }

  /**
   * Poll a server-side function at the given interval, to have
   * results passed to a successHandler callback. There's no other
   * means to determine if the user has made changes (namely, changes
   * to cell selection) in client-side code.
   *
   * https://stackoverflow.com/a/24773178/1677912
   *
   * @param {Number} interval   (optional) Time in ms between polls.
   *                            Default is 2s (2000ms)
   */
  function poll(interval) {
      interval = interval || 500;

      setTimeout(function () {
          updateCellRange();
      }, interval);
  
      setTimeout(function () {
          checkAlive();
          setAlive();
      }, 5000);
  }
</script>

